# [4팀] 최애의 포토

<p align="center">
<img src="https://private-user-images.githubusercontent.com/49442904/450694275-8edeaded-c705-45d5-9334-a232067d7092.jpg?jwt=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJnaXRodWIuY29tIiwiYXVkIjoicmF3LmdpdGh1YnVzZXJjb250ZW50LmNvbSIsImtleSI6ImtleTUiLCJleHAiOjE3NDg5NDQ5MjMsIm5iZiI6MTc0ODk0NDYyMywicGF0aCI6Ii80OTQ0MjkwNC80NTA2OTQyNzUtOGVkZWFkZWQtYzcwNS00NWQ1LTkzMzQtYTIzMjA2N2Q3MDkyLmpwZz9YLUFtei1BbGdvcml0aG09QVdTNC1ITUFDLVNIQTI1NiZYLUFtei1DcmVkZW50aWFsPUFLSUFWQ09EWUxTQTUzUFFLNFpBJTJGMjAyNTA2MDMlMkZ1cy1lYXN0LTElMkZzMyUyRmF3czRfcmVxdWVzdCZYLUFtei1EYXRlPTIwMjUwNjAzVDA5NTcwM1omWC1BbXotRXhwaXJlcz0zMDAmWC1BbXotU2lnbmF0dXJlPWI2NDg4MjA0NmE5MmFjMzUxZmNiZDBkMTk4MzJkZmZkNDRiY2I4MjM3YmFiOWYzN2Q4OTdjNGMyZTg1NjQ5NGQmWC1BbXotU2lnbmVkSGVhZGVycz1ob3N0In0.VjpXWdGcUsW1W_Z_oB6SvXYxImJC4qUMseN20vC-Q6M" alt="메인 사진" />
</p>
<br />

## 📑 목차

1. 🔹 [프로젝트 소개](#프로젝트-소개)
2. 🔹 [기술 스택](#기술-스택)
3. 🔹 [시스템 아키텍쳐](#시스템-아키텍쳐)
4. 🔹 [팀원 소개](#팀원-소개)
5. 🔹 [프로젝트 기능](#프로젝트-기능)
6. 🔹 [트러블 슈팅](#트러블-슈팅)

<br />

## 📸 프로젝트 소개

https://github.com/user-attachments/assets/20c3e346-5d42-486d-8de4-a9c2e8f49e68

최애의 포토는 당신의 ‘최애’ 순간들을 사진으로 담아 간직하고 공유할 수 있는 감성 기반의 포토 기록 플랫폼입니다. ‘가장 좋아하는 것’을 뜻하는 ‘최애’와 소중한 ‘사진’을 모은다는 의미에서 탄생했습니다. 일상 속에서 놓치고 싶지 않은 순간들, 나만의 취향과 감정을 표현하고 싶은 사진들, 최애의 포토에 담아보세요. 흘러가는 SNS가 아닌, 당신만의 의미 있는 아카이브 공간에서 특별한 사진들을 모으고, 정리하고, 간직해보세요.

1️⃣ **카드 생성**: 내가 좋아하는 사진을 온라인 공간에 올리고 저장할 수 있습니다.

2️⃣ **포인트 제도**: 한 시간에 한 번, 랜덤 포인트를 받을 수 있고, 그 포인트로 카드를 거래할 수 있습니다.

3️⃣ **카드 거래**: 내가 만든 카드를 판매하거나 다른 사용자가 만든 카드를 구입할 수 있습니다.

4️⃣ **카드 교환**: 내 카드와 판매 중인 카드를 1:1 교환할 수 있습니다.

5️⃣ **알림 기능**: 카드 거래·교환 시 *실시간*으로 알림을 받습니다.

6️⃣ **다양한 필터 기능**: 상황에 따라 검색, 정렬, 필터링 기능을 제공합니다.

<br />


## 🔗 팀 문서 보기  
👉 [Notion 링크 바로가기](https://www.notion.so/4-1f388b3cb86180888609db626a03fb0a)  

➡️ 다음은 프론트엔드 Git 저장소입니다.  
🔧 [GitHub Repository 보러가기](https://github.com/afafmmm/6-FavoritePhoto-4team-fe)


<br />

## 🖥️ 기술 스택

#### ✔️ 언어
<span><img src="https://img.shields.io/badge/javascript-F7DF1E?style=for-the-badge&logo=javascript&logoColor=white" alt="javascript" /></span>
<span><img src="https://img.shields.io/badge/PostgreSQL-336791?style=for-the-badge&logo=postgresql&logoColor=white" alt="PostgreSQL" /></span>

#### ✔️ 프레임워크 & 라이브러리
<span><img src="https://img.shields.io/badge/Express-000000?style=for-the-badge&logo=express&logoColor=white" alt="Express" /></span>
<span><img src="https://img.shields.io/badge/Prisma-2D3748?style=for-the-badge&logo=prisma&logoColor=white" alt="Prisma" /></span>
<span><img src="https://img.shields.io/badge/passport-34E27A?style=for-the-badge&logo=passport&logoColor=white" alt="passport" /></span>
<span><img src="https://img.shields.io/badge/jsonwebtokens-000000?style=for-the-badge&logo=jsonwebtokens&logoColor=white" alt="jsonwebtokens" /></span>
<span><img src="https://img.shields.io/badge/socketdotio-010101?style=for-the-badge&logo=socketdotio&logoColor=white" alt="socketdotio" /></span>

#### ✔️ 버전 관리 외
<span><img src="https://img.shields.io/badge/Git-F05032?style=for-the-badge&logo=git&logoColor=white" alt="Git" /></span>
<span><img src="https://img.shields.io/badge/GitHub-181717?style=for-the-badge&logo=github&logoColor=white" alt="GitHub" /></span>
<span><img src="https://img.shields.io/badge/Node.js-339933?style=for-the-badge&logo=node.js&logoColor=white" alt="Node.js" /></span>
<span><img src="https://img.shields.io/badge/npm-CB3837?style=for-the-badge&logo=npm&logoColor=white" alt="npm" /></span>

#### ✔️ 배포
<span><img src="https://img.shields.io/badge/render-000000?style=for-the-badge&logo=render&logoColor=white" alt="render" /></span>

<br />

## 💾 시스템 아키텍쳐

(FE 아키텍쳐는 따로 있습니다.)

![Web App Reference Architecture (1)](https://github.com/user-attachments/assets/15283051-29b9-4b74-8375-3c4f14f73531)



<br />

## 👫 팀원 소개

<table align="center">
  <tbody>
    <tr>
      <td align="center">
        <a href="https://github.com/afafmmm">
          <img src="https://github.com/afafmmm.png?size=100" width="100px" alt="이지수 GitHub"/>
          <br />
          <sub><b>이지수</b></sub>
        </a>
      </td>
      <td align="center">
        <a href="https://github.com/fs6-kde">
          <img src="https://github.com/fs6-kde.png?size=100" width="100px" alt="김다은 GitHub"/>
          <br />
          <sub><b>김다은</b></sub>
        </a>
      </td>
      <td align="center">
        <a href="https://github.com/wooju01">
          <img src="https://github.com/wooju01.png?size=100" width="100px" alt="김우주 GitHub"/>
          <br />
          <sub><b>김우주</b></sub>
        </a>
      </td>
      <td align="center">
        <a href="https://github.com/writing-sky">
          <img src="https://github.com/writing-sky.png?size=100" width="100px" alt="양성경 GitHub"/>
          <br />
          <sub><b>양성경</b></sub>
        </a>
      </td>
      <td align="center">
        <a href="https://github.com/xdnjs7">
          <img src="https://github.com/xdnjs7.png?size=100" width="100px" alt="장원빈 GitHub"/>
          <br />
          <sub><b>장원빈</b></sub>
        </a>
      </td>
      <td align="center">
        <a href="https://github.com/az0319h">
          <img src="https://github.com/az0319h.png?size=100" width="100px" alt="홍성훈 GitHub"/>
          <br />
          <sub><b>홍성훈</b></sub>
        </a>
      </td>
    </tr>
  </tbody>
</table>

<br />

## 🕹️ 프로젝트 기능
### 1. ERD
![image](https://github.com/user-attachments/assets/67b8d924-4f42-40a0-8912-050f2dedc801)

<br />

### 2. API 목록
#### 👤 사용자 [`User`]
| Method | Endpoint                    | 설명               |
| ------ | --------------------------- | ---------------- |
| GET    | `/users`                    | 로그인한 사용자 정보 조회   |
| GET    | `/users/card-meta`          | 장르 + 등급 메타 정보 조회 |
| GET    | `/users/monthly-post-count` | 월별 카드 생성 횟수 조회   |
| GET    | `/users/cards-count`        | 사용자 카드 수량 (등급별)  |
| POST   | `/users/post`               | 포토카드 등록          |
| GET    | `/users/gallery`            | 내 카드 갤러리 조회      |
| GET    | `/users/gallery/:id`        | 특정 포토카드 상세 조회    |
| GET    | `/users/cards-on-sale`      | 판매/교환 중인 카드 조회   |


#### 🆔 인증 [`Auth`]
| Method | Endpoint                | 설명              |
| ------ | ----------------------- | --------------- |
| POST   | `/auth/signup`          | 회원가입            |
| POST   | `/auth/login`           | 로그인             |
| POST   | `/auth/logout`          | 로그아웃            |
| POST   | `/auth/refresh-token`   | 액세스 토큰 재발급      |
| GET    | `/auth/google`          | 구글 OAuth 로그인 시작 |
| GET    | `/auth/google/callback` | 구글 로그인 콜백       |
| GET    | `/auth/google/fail`     | 구글 로그인 실패       |



#### 💳 판매 [`Sale`]
| Method | Endpoint               | 설명       |
| ------ | ---------------------- | -------- |
| POST   | `/sales/cards`         | 카드 판매 등록 |
| GET    | `/sales/cards/:saleId` | 판매 상세 조회 |
| PATCH  | `/sales/cards/:saleId` | 판매 수정    |
| DELETE | `/sales/cards/:saleId` | 판매 취소    |


#### 🛍️ 구매 [`Purchase`]
| Method | Endpoint                       | 설명       |
| ------ | ------------------------------ | -------- |
| POST   | `/purchase/cards/:id/purchase` | 카드 구매 요청 |


#### 🔄 교환 [`Trade`]
| Method | Endpoint                        | 설명                |
| ------ | ------------------------------- | ----------------- |
| GET    | `/cards/:saleId/trade-requests` | 특정 판매카드의 교환 요청 목록 |
| PATCH  | `/trade/:id/accept`             | 교환 요청 수락          |
| PATCH  | `/trade/:id/reject`             | 교환 요청 거절          |


##### 🔄 교환 요청 [`TradeRequest`]
| Method | Endpoint                                               | 설명               |
| ------ | ------------------------------------------------------ | ---------------- |
| POST   | `/cards/:saleId/exchange`                              | 교환 요청 생성         |
| PATCH  | `/cards/:listedCardId/exchange/:tradeRequestId/cancel` | 교환 요청 취소         |
| GET    | `/cards/:saleId/exchange`                              | 신청자의 교환 요청 목록 조회 |


#### 💰 포인트 [`Point`]
| Method | Endpoint             | 설명           |
| ------ | -------------------- | ------------ |
| POST   | `/points/random-box` | 랜덤 포인트 상자 뽑기 |
| GET    | `/points/me`         | 내 포인트 조회     |
| POST   | `/points/update`     | 포인트 증감 처리    |


#### 🔔 알림 [`/notification`]
| Method | Endpoint                  | 설명           |
| ------ | ------------------------- | ------------ |
| POST   | `/notifications`          | 알림 생성        |
| GET    | `/notifications`          | 사용자 알림 목록 조회 |
| GET    | `/notifications/:id`      | 알림 상세 조회     |
| PATCH  | `/notifications/:id/read` | 알림 읽음 처리     |
| DELETE | `/notifications/:id`      | 알림 삭제        |


<br />

## 💣 트러블 슈팅
<a name="troubleshooting"></a>
<details>
<summary>🖼️ 판매 수정 : `saleQuantity` 계산</summary>

<br>

### 🔧 문제 상황
- 판매 수정에서 판매 수량을 변경할 때, 기존 판매 수량보다 많을 경우와 반대로 더 적을 경우에 대한 구현이 어려웠음 
- 각 카드의 상태도 같이 바뀌어야 하고, 동시에 판매 수량과 보유 수량의 숫자가 동시에 바뀌어야 하기 때문에 복잡했음음

### 📌 원인 파악
- 보유수량 카드 조회 부분에선 실제 유저가 소유한 **보유 카드를 객체로 그 수만큼 나열**하여 구현하기 편했으나,
- 판매 카드 관련 조회는 객체 나열이 아닌 **숫자로만 계산하는 구조**로 되어 있어 이 둘을 합쳐서 구현하기 쉽지 않았음
  
### 🛠️ 해결 방법
- `quantityDiff`로 **변경한 판매수량값과 기존 판매 수량값의 차이를 계산한 변수**를 만들어
- `quantityDiff`가 0보다 크면, 즉 기존 판매수량보다 큰값으로 변경하면 보유수량 카드에서 `quantityDiff`만큼 가져와 추가
- `quantityDiff`가 0보다 작으면, 즉 기존 판매수량보다 더 작은값으로 변경하면 판매등록된 카드에서 `quantityDiff`만큼 다시 보유수량 카드로 돌아감

### ✅ 전환 결과
- `quantityDiff`를 따로 만들어 계산하니 판매수량 수정이 알맞게 작동함
- 보유수량 카드에서 더 가져와야 하는 경우엔, 보유수량 카드 조회에서 그만큼 객체가 빠져나갔음
- 판매한 카드를 다시 보유수량 카드로 전환하는 경우엔, 보유수량 카드 조회에서 그만큼 객체가 다시 생성됐음 

### 💻 문제 해결 방법 CODE

판매수량값 갱신 문제를 해결한 코드입니다:

```ts
if (updatePayload.saleQuantity !== undefined) {
      const quantityDiff = updatePayload.saleQuantity - sale.saleQuantity;

      if (quantityDiff > 0) {
        const extraCards = await tx.userCard.findMany({
          where: {
            ownerId: userId,
            photoCardId: sale.photoCardId,
            status: 'ACTIVE'
          },
          take: quantityDiff
        });

        await Promise.all(
          extraCards.map((card) =>
            tx.saleUserCard.create({
              data: {
                saleId,
                userCardId: card.id
              }
            })
          )
        );

        await tx.userCard.updateMany({
          where: { id: { in: extraCards.map((c) => c.id) } },
          data: { status: 'AVAILABLE' }
        });
      } else if (quantityDiff < 0) {
        const removeCount = -quantityDiff;
        const removableCards = sale.saleUserCards.slice(-removeCount);

        await tx.saleUserCard.deleteMany({
          where: { id: { in: removableCards.map((r) => r.id) } }
        });

        await tx.userCard.updateMany({
          where: { id: { in: removableCards.map((r) => r.userCardId) } },
          data: { status: 'ACTIVE' }
        });
      }
